app-id: com.github.cristiano.RedragonVolumeSync
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: redragon-volume-sync-gui
finish-args:
  # Acesso ao sistema de som
  - --socket=pulseaudio
  - --socket=session-bus
  - --socket=system-bus

  # Acesso a dispositivos de Ã¡udio
  - --device=all

  # Filesystem access
  - --filesystem=home
  - --filesystem=~/.config/pipewire:rw
  - --filesystem=~/.config/systemd/user:rw
  - --filesystem=~/.local/bin:rw
  - --filesystem=~/.local/share/gnome-shell/extensions:rw
  - --filesystem=~/.local/share/cinnamon/applets:rw

  # Systemd access (limited in flatpak)
  - --talk-name=org.freedesktop.systemd1

  # System calls needed for ALSA
  - --allow=per-app-dev-shm

  # Required for hardware access
  - --share=ipc

modules:
  - name: python3-dependencies
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-deps --no-build-isolation .
    sources:
      - type: inline
        dest-filename: setup.py
        contents: |
          from setuptools import setup
          setup(
              name='redragon-volume-sync',
              version='1.0.0',
              py_modules=[],
          )

  - name: redragon-volume-sync
    buildsystem: simple
    build-commands:
      # Install Python scripts
      - install -Dm755 redragon_volume_sync.py /app/bin/redragon_volume_sync.py
      - install -Dm755 redragon_daemon.py /app/bin/redragon_daemon.py
      - install -Dm755 redragon_event_monitor.py /app/bin/redragon_event_monitor.py
      - install -Dm755 redragon-volume /app/bin/redragon-volume
      - install -Dm755 configure-pipewire.sh /app/bin/configure-pipewire.sh

      # Create symlinks
      - ln -s /app/bin/redragon_volume_sync.py /app/bin/redragon-sync

      # Install systemd service (user will need to copy manually)
      - install -Dm644 redragon-volume-sync.service /app/share/redragon-volume-sync/redragon-volume-sync.service

      # Install PipeWire config template
      - install -Dm644 pipewire-redragon-template.conf /app/share/redragon-volume-sync/pipewire-redragon-template.conf

      # Install GNOME extension
      - mkdir -p /app/share/gnome-shell/extensions/redragon-volume-sync@cristiano
      - cp -r gnome-extension/* /app/share/gnome-shell/extensions/redragon-volume-sync@cristiano/

      # Install Cinnamon applet
      - mkdir -p /app/share/cinnamon/applets/redragon-volume-sync@cristiano
      - cp -r cinnamon-applet/* /app/share/cinnamon/applets/redragon-volume-sync@cristiano/

      # Install documentation
      - install -Dm644 README.md /app/share/doc/redragon-volume-sync/README.md
      - install -Dm644 ANALOG_OUTPUT.md /app/share/doc/redragon-volume-sync/ANALOG_OUTPUT.md

      # Install desktop file and icon
      - install -Dm644 com.github.cristiano.RedragonVolumeSync.desktop /app/share/applications/com.github.cristiano.RedragonVolumeSync.desktop
      - install -Dm644 icons/redragon-volume-sync.svg /app/share/icons/hicolor/scalable/apps/com.github.cristiano.RedragonVolumeSync.svg

      # Install post-install script
      - install -Dm755 flatpak-post-install.sh /app/bin/redragon-volume-sync-gui

    sources:
      - type: dir
        path: .

name: Build and Publish Flatpak

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-23.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: redragon-hs-companion.flatpak
          manifest-path: com.github.cristianocps.RedragonHSCompanion.yaml
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak bundle
        uses: actions/upload-artifact@v4
        with:
          name: redragon-hs-companion-flatpak
          path: redragon-hs-companion.flatpak
          retention-days: 30

  publish-flathub:
    name: Publish to Flathub (on release)
    runs-on: ubuntu-latest
    needs: build-flatpak
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Flatpak bundle
        uses: actions/download-artifact@v4
        with:
          name: redragon-hs-companion-flatpak

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: redragon-hs-companion.flatpak
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Flathub (info)
        run: |
          echo "To publish to Flathub:"
          echo "1. Fork https://github.com/flathub/flathub"
          echo "2. Add your manifest to flathub/com.github.cristianocps.RedragonHSCompanion"
          echo "3. Create a Pull Request"
          echo ""
          echo "Documentation: https://docs.flathub.org/docs/for-app-authors/submission/"

  test-install:
    name: Test Installation
    runs-on: ubuntu-latest
    needs: build-flatpak

    steps:
      - name: Setup Flatpak
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Download Flatpak bundle
        uses: actions/download-artifact@v4
        with:
          name: redragon-hs-companion-flatpak

      - name: Install Flatpak bundle
        run: |
          flatpak install -y --bundle redragon-hs-companion.flatpak

      - name: Test Flatpak installation
        run: |
          flatpak list | grep RedragonHSCompanion
          echo "âœ… Flatpak installed successfully!"

#!/bin/bash
# Fast client for the Redragon Control Daemon
# Uses Unix socket to avoid Python startup overhead

SOCKET="${XDG_RUNTIME_DIR:-/tmp}/redragon-control.sock"

# Check if the daemon is running
if [ ! -S "$SOCKET" ]; then
    echo "Error: Daemon is not running" >&2
    echo "Execute: systemctl --user start redragon-control-daemon" >&2
    exit 1
fi

# Function to send command via socket
send_command() {
    local cmd="$1"
    # Try without -N first (ncat/nmap on Fedora), fallback with -N (GNU netcat)
    # ncat doesn't support -N flag, so we try without it first
    if echo "$cmd" | nc -U "$SOCKET" 2>/dev/null; then
        return 0
    elif echo "$cmd" | nc -U -N "$SOCKET" 2>/dev/null; then
        return 0
    else
        echo "Error communicating with daemon" >&2
        return 1
    fi
}

# Process arguments
if [ $# -eq 0 ]; then
    echo "Usage: $0 <volume|status|get|mute>"
    echo "  $0 50          # Define volume to 50%"
    echo "  $0 status      # Show status"
    echo "  $0 get         # Get current volume"
    echo "  $0 mute        # Mute/unmute (toggle)"
    exit 1
fi

case "$1" in
    status)
        send_command "status"
        ;;
    get)
        response=$(send_command "get")
        if [[ "$response" == OK:* ]]; then
            volume="${response#OK: }"
            echo "Volume: $volume%"
        else
            echo "$response" >&2
            exit 1
        fi
        ;;
    mute)
        response=$(send_command "mute")
        if [[ "$response" == OK:* ]]; then
            echo "OK"
        else
            echo "$response" >&2
            exit 1
        fi
        ;;
    [0-9]*)
        volume="$1"
        if [ "$volume" -lt 0 ] || [ "$volume" -gt 100 ]; then
            echo "Volume must be between 0 and 100" >&2
            exit 1
        fi
        response=$(send_command "set $volume")
        if [[ "$response" == OK:* ]]; then
            echo "Volume: ${response#OK: }%"
        else
            echo "$response" >&2
            exit 1
        fi
        ;;
    *)
        echo "Invalid command: $1" >&2
        exit 1
        ;;
esac

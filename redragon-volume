#!/bin/bash
# Redragon Volume Control
# Script wrapper para controlar o volume de headsets Redragon via ALSA (com sincronização automática)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SYNC_SCRIPT="$HOME/.local/bin/redragon_volume_sync.py"

# Se não está instalado, tenta outros caminhos
if [ ! -f "$SYNC_SCRIPT" ]; then
    # Tenta link simbólico
    SYNC_SCRIPT="$HOME/.local/bin/redragon-sync"
fi

if [ ! -f "$SYNC_SCRIPT" ]; then
    # Tenta diretório local
    SYNC_SCRIPT="$SCRIPT_DIR/redragon_volume_sync.py"
fi

usage() {
    cat << EOF
Redragon Volume Control

Controla o volume de headsets Redragon sem fio (H878, H848, etc) via ALSA.

Uso:
  $(basename $0) <volume>              Define volume (0-100)
  $(basename $0) +<valor>              Aumenta volume
  $(basename $0) -<valor>              Diminui volume
  $(basename $0) up                    Aumenta 5%
  $(basename $0) down                  Diminui 5%
  $(basename $0) mute                  Muta/desmuta
  $(basename $0) status                Mostra status atual

Exemplos:
  $(basename $0) 75                    Define volume para 75%
  $(basename $0) +10                   Aumenta 10%
  $(basename $0) -5                    Diminui 5%
  $(basename $0) up                    Aumenta 5%
  $(basename $0) down                  Diminui 5%

Nota: Este script ajusta os controles ALSA diretamente.
      O daemon irá sincronizar automaticamente PCM[0] e PCM[1].
EOF
    exit 1
}

get_current_volume() {
    "$SYNC_SCRIPT" status 2>/dev/null | grep "PCM Volume (2 canais)" | grep -oP '\d+(?=%)'
}

set_volume() {
    local vol=$1

    # Limita entre 0 e 100
    if [ $vol -lt 0 ]; then
        vol=0
    elif [ $vol -gt 100 ]; then
        vol=100
    fi

    # IMPORTANTE: Coloca PipeWire em 100% para desativar controle de software
    # Isso evita que o PipeWire interfira com os controles ALSA
    local SINK=$(pactl list sinks short 2>/dev/null | grep -E 'XiiSound|Weltrend|Redragon' | awk '{print $2}' | head -n 1)
    if [ -n "$SINK" ]; then
        pactl set-sink-volume "$SINK" 100% 2>/dev/null || true
        sleep 0.2  # Aguarda PipeWire estabilizar
    fi

    "$SYNC_SCRIPT" set $vol

    # Aguarda daemon sincronizar PCM[0] → PCM[1]
    sleep 0.5
}

if [ $# -eq 0 ]; then
    usage
fi

case "$1" in
    status)
        "$SYNC_SCRIPT" status
        ;;
    up)
        current=$(get_current_volume)
        new=$((current + 5))
        set_volume $new
        echo "Volume: $new%"
        ;;
    down)
        current=$(get_current_volume)
        new=$((current - 5))
        set_volume $new
        echo "Volume: $new%"
        ;;
    mute)
        current=$(get_current_volume)
        if [ "$current" -eq 0 ]; then
            # Desmuta (volta para 50%)
            set_volume 50
            echo "Desmutado: 50%"
        else
            # Muta
            set_volume 0
            echo "Mutado"
        fi
        ;;
    +*)
        # Aumenta
        increment="${1:1}"
        current=$(get_current_volume)
        new=$((current + increment))
        set_volume $new
        echo "Volume: $new%"
        ;;
    -*)
        # Diminui
        decrement="${1:1}"
        current=$(get_current_volume)
        new=$((current - decrement))
        set_volume $new
        echo "Volume: $new%"
        ;;
    [0-9]*)
        # Define valor absoluto
        set_volume $1
        echo "Volume: $1%"
        ;;
    *)
        echo "Erro: Comando desconhecido: $1"
        echo
        usage
        ;;
esac

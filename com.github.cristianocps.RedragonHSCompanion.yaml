app-id: com.github.cristianocps.RedragonHSCompanion
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: redragon-hs-companion-setup

finish-args:
  # Access to sound devices (ALSA)
  - --device=all
  # Access to PulseAudio/PipeWire
  - --socket=pulseaudio
  # Access to system D-Bus (for systemd user services)
  - --socket=system-bus
  # Access to session D-Bus
  - --socket=session-bus
  # Access to home directory for config files
  - --filesystem=home
  # Access to ~/.local/bin for scripts
  - --filesystem=~/.local/bin:create
  # Access to systemd user directory
  - --filesystem=~/.config/systemd/user:create
  # Access to GNOME Shell extensions
  - --filesystem=~/.local/share/gnome-shell/extensions:create
  # Access to Cinnamon applets
  - --filesystem=~/.local/share/cinnamon/applets:create
  # Access to KDE Plasma widgets
  - --filesystem=~/.local/share/plasma/plasmoids:create
  # Talk to systemd
  - --talk-name=org.freedesktop.systemd1
  # Access to hardware info
  - --system-talk-name=org.freedesktop.UDisks2

modules:
  - name: python3-dependencies
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-deps .
    sources:
      - type: inline
        dest-filename: setup.py
        contents: |
          from setuptools import setup
          setup(
              name='redragon-volume-sync',
              version='2.0.0',
              py_modules=['redragon_volume_sync']
          )
      - type: file
        path: redragon_volume_sync.py

  - name: redragon-hs-companion
    buildsystem: simple
    build-commands:
      # Install Python scripts
      - install -Dm755 redragon_volume_sync.py /app/bin/redragon_volume_sync.py
      - install -Dm755 redragon_daemon.py /app/bin/redragon_daemon.py
      - install -Dm755 redragon_control_daemon.py /app/bin/redragon_control_daemon.py
      - install -Dm755 redragon-volume /app/bin/redragon-volume

      # Install desktop file
      - install -Dm644 com.github.cristianocps.RedragonHSCompanion.desktop /app/share/applications/com.github.cristianocps.RedragonHSCompanion.desktop

      # Install icon
      - install -Dm644 icons/com.github.cristianocps.RedragonHSCompanion.svg /app/share/icons/hicolor/scalable/apps/com.github.cristianocps.RedragonHSCompanion.svg

      # Install AppStream metadata
      - install -Dm644 com.github.cristianocps.RedragonHSCompanion.metainfo.xml /app/share/metainfo/com.github.cristianocps.RedragonHSCompanion.metainfo.xml

      # Install setup script
      - install -Dm755 flatpak-setup.sh /app/bin/redragon-hs-companion-setup

      # Install GNOME extension
      - mkdir -p /app/share/gnome-shell/extensions/redragon-volume-sync@cristiano
      - cp -r gnome-extension/* /app/share/gnome-shell/extensions/redragon-volume-sync@cristiano/

      # Install Cinnamon applet
      - mkdir -p /app/share/cinnamon/applets/redragon-volume-sync@cristiano
      - cp -r cinnamon-applet/* /app/share/cinnamon/applets/redragon-volume-sync@cristiano/

      # Install Plasma widget
      - mkdir -p /app/share/plasma/plasmoids/redragon-volume-sync@cristiano
      - cp -r plasma-widget/* /app/share/plasma/plasmoids/redragon-volume-sync@cristiano/

    sources:
      - type: git
        url: https://github.com/cristianocps/redragon-hs-companion.git
        tag: v2.0.0
        commit: HEAD

      - type: file
        path: flatpak-setup.sh

      - type: file
        path: com.github.cristianocps.RedragonHSCompanion.desktop

      - type: file
        path: com.github.cristianocps.RedragonHSCompanion.metainfo.xml
